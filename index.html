<script>
  console.log("fetching visitor stats...");

  fetch("https://sheetdb.io/api/v1/ovgpnrzj00t4b")
    .then(response => response.json())
    .then(data => {
      console.log("parsed visitor data:", data);
      const visits = data.length;
      document.getElementById("visit-count").textContent =
        `you are visitor number ${visits}`;

      const sixHours = 6 * 60 * 60 * 1000;
      const seen = {};

      const filtered = data
        .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
        .filter(entry => {
          const ip = entry.ip || "";
          const time = new Date(entry.timestamp).getTime() || Date.now();
          if (!seen[ip]) {
            seen[ip] = time;
            return true;
          }
          const lastTime = seen[ip];
          if (lastTime - time >= sixHours) {
            seen[ip] = time;
            return true;
          }
          return false;
        });

      const logContainer = document.getElementById("visitor-log");
      const rows = filtered.map(entry => {
        const dateObj = new Date(entry.timestamp);
        const isValidDate = !isNaN(dateObj.getTime());

        let dateStr = "present place";
        let timeStr = "present time";

        if (isValidDate) {
          const month = dateObj.getMonth() + 1;
          const day = dateObj.getDate();
          const year = dateObj.getFullYear().toString().slice(-2);
          dateStr = `${month}.${day}.${year}`;

          timeStr = dateObj.toLocaleTimeString("en-US", {
            hour12: false,
            hour: "2-digit",
            minute: "2-digit",
            second: "2-digit"
          });
        }

        const city = (entry.city || "nowhere").toLowerCase();
        const country = (entry.country || "zz").toLowerCase();
        const location = `${city}, ${country}`;

        return `${dateStr} ${timeStr} ${location}`;
      });

      logContainer.innerHTML = rows.map(r => `<p>${r}</p>`).join("");
    })
    .catch(error => {
      console.error("failed to load visitor data:", error);
    });
</script>
